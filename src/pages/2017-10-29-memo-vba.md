---
title: 关于 VBA 的笔记
subtitle: 工作中使用 VBA 写了个小工具提高了一些效率，记录一下相关的资料。虽然据说这东西快要被淘汰了。
date: 2017-10-29 15:20:10
tags:
  - vba
---

### 途中又转了个一圈

表设计重申好了，本来准备搭建环境准备开发 DAO 相关的类了，结果是环境搭建到一半，途中对 VBA 产生了兴趣。

好吧，兴趣是最好的老师，既然老师来了，那就好好的听上一节课咯！

所以就有了这篇笔记，别管那么多，看看 VBA 怎么用的吧。

我对这东西的评价就是：

**掌握了可以提高几倍工作效率。**

所以还是值得一学的，毕竟平时还有不少重复性的又枯燥的工作存在的，我们没必要每次都花时间去处理那些工作呀，将时间放在更具有创造性的事情上不是更有趣吗！！！

承上，咱先看看 VBA 的原理。

### VBA 的基本实现

说到 VBA，这货是 Excel 的根本实现。我们在 Excel 中的任何操作都可以转化成 VBA 代码代替我们实现。于是，如果我们有一段重复性的对 Excel 操作的流程的话，将其转化为 VBA 代码吧！这样我们就可以动动手指，看着程序自动帮我们完成工作了。

想理解 VBA 的工作原理，最方便的方法是用宏录制工具录制一些操作，生成一些 VBA 代码，来看看这些代码是如何帮助我们完成我们所需的操作的吧。

要做到这一点，我们需要在 Excel 中启用开发工具。（上面纯文字太多了，下面直接上图咯）

**在工具栏空白处点击鼠标右键，选择自定义功能区**

![自定义功能区](/img/memo-vba/open-tool.gif)

**在弹出的菜单中勾选开发工具**

![启用开发工具](/img/memo-vba/open-tool-2.gif)

开启后我们就可以在工具栏看到下面的界面啦。

![开发工具](/img/memo-vba/tool.gif)

工具开启了，接下来我们就窥看一下究竟何谓 VBA 吧！

首先想一个需求。大概做成下面这个样子吧，先来简单点的，看看效果。这里我是随手写了几个名字，然后给表头加上了筛选。

![sheet1](/img/memo-vba/sheet1.gif)

我们在这个数据上做一个筛选，把小林剔除掉。

![sheet1-2](/img/memo-vba/sheet1-2.gif)

我们点击录制宏工具之后按照上面这样操作一遍。

![使用录制宏](/img/memo-vba/use-tool.gif)

结束时再点击一下停止录制。

![停止录制宏](/img/memo-vba/use-tool-2.gif)

然后我们按`Alt+F11`打开 VBA 界面。找到刚才生成的 VBA 代码，一般在下面这个文件中。

![宏文件](/img/memo-vba/vba-1.gif)

点开它，我们就可以看到工具自动生成的代码。

![宏代码](/img/memo-vba/vba-2.gif)

我们仔细一看，可以发现每一行都是我们的一个操作。

下面逐行理解一下这段代码。

首先 VBA 的方法以`Sub 方法名()`开头，以`End Sub`结尾，中间被包括起来的部分就是方法体了。

其次我们了解到在 VBA 中，以`'（单引号）`表示注释。我们来看方法体。

`Range("A1").Select`表示我们的第一个操作，鼠标左键点击 A1 单元格，这时 A1 是被选中的状态。

`ActiveCell.FormulaR1C1 = "姓名"`是我们的第二个操作，给激活的单元格赋值为`姓名`。这里使用了`FormulaR1C1`方法赋值，这个方法可以给单元格赋值公式。（具体后面提到的话再详细说）

选择单元格并且赋值的操作循环了几次，直到`Selection.AutoFilter`这一步，这一步的前一句和一开始一样`Range("A1").Select`，我们重新点击选中了单元格 A1，然后给 A1 打开了筛选。到这里我们的数据展示基本完成了。下面就是进一步筛选数据了。

`ActiveSheet.Range("$A$1:$A$7").AutoFilter Field:=1, Criteria1:=Array("李四", _`这一句表示在`$A$1:$A$7`这个绝对引用的范围内调用`AutoFilter`方法，其参数是`Field`筛选基准字段的偏移量为 1，`Criteria1`筛选条件为后面列出的一个数组，这个数组中包括的值是显示的值。但是这句话没有结束，这里使用了`_（下划线）`表示换行，下一行仍然是这一句代码。

`"南宫", "欧阳", "王五", "张三"), Operator:=xlFilterValues`这是上一行的后续，补充完整了显示出来的值的数组，并且`Operator`属性指定了筛选的类型。（这个筛选类型暂时还不太清楚是什么意思）这里我们把小林给筛除了，所以数组中并没有小林。

我们可以尝试的运行一下宏，我们先添加一个新的 sheet，在新的 sheet 上按`Alt+F8`打开宏选框，选择刚才录制的宏，点执行。

![使用宏](/img/memo-vba/use-macro.gif)

宏运行结束之后，我们可以看到在新的 sheet 上我们得到了和一开始操作完全一致的结果。

到这里我们的首次尝试结束了。但是我们的重点其实并不是如何使用录制宏。这里录制宏生成的代码也有些呆板，如果是我们自己写的话，应该会写成下面这样，得到的结果和我们第一次操作的结果一致。

```c
Sub Test()
    With ActiveSheet
        .Cells(1, 1).Value = "姓名"
        .Cells(2, 1).Value = "张三"
        .Cells(3, 1).Value = "李四"
        .Cells(4, 1).Value = "王五"
        .Cells(5, 1).Value = "欧阳"
        .Cells(6, 1).Value = "南宫"
        .Cells(7, 1).Value = "小林"
    End With
    ActiveSheet.Range("A1").AutoFilter Field:=1, Criteria1:=Array("李四", _
        "南宫", "欧阳", "王五", "张三"), Operator:=xlFilterValues
End Sub
```

通过这些代码的阅读，其实我们已经可以看出 VBA 的基本构成了。

我个人使用 VBA 写了一些代码之后的感受（并没有用很久）：

**VBA 是面向对象的基于 API 操作 Excel 的语言。**

VBA 内部封装了很多 Excel 元素的对象，例如 sheet，cell，column，row 等。我们对 Excel 可以做的任何操作用 VBA 同样可以实现。

同时，VBA 操作 Excel 具有先天优势，虽然可能同样的操作在其他语言中有更简单的写法，但不同与其他语言需要依赖开发环境，运行环境以及 Excel 对接，VBA 仅依赖于 Office 软件，而不依赖系统，IDE，或者其他任何运行环境。

好了，废话有点多，接下来看看 VBA 的基础吧。

### VBA 基础-对象，属性，方法，事件

之前提到 VBA 面向对象，其实也是我想岔了。

VBA 里面确实封装了很多对象，所有我们能操作的元素都是对象，但是并非我们面向对象编程，而是我们使用这些存在的对象编写操作过程。其实对我们来说还是面向过程编程，即函数式编程。

我们不能新建一个类，然后实例化它（至少就我不多的了解是不行的），我们做的最大程度也无非写几个 function 在 sub 里面 call 一下它们。

相对于没有返回值的 sub，function 是有返回值的函数。

虽然 VBA 存在一些缺点，也无法做到类似 Java 或者其他语言能完成的复杂工作，但是在操作 Excel 方面还是没人能比得过它的。

先说几个概念。

对象，这个不多说，OOP 太熟悉了，VBA 中我们能遇到的所有 Excel 组成成分都以对象的身份参与到我们的代码中。

属性，这个也没什么好说的，对象的属性，影响对象的存在。

方法，这个就是我们编程的主要内容了，我们要写出操作对象和属性的代码，这些代码都在各个方法里面等待被执行。

事件，熟悉 JS 的话也很好理解，Java 里面 GUI 也涉及到事件，VBA 中的事件有鼠标操作，键盘操作，单元格的选择与值的修改等等都是一个个事件，我们可以编写在这些事件触发时的程序来满足我们的需求。也是很方便的东西。

以上，虽然我解释的并不是很多，毕竟我是以有其他编程语言基础的角度来简单的介绍这些概念的。如果阅读这篇文章的你不理解对象的概念的话，简单百度一下 OOP。

说到这里，都很好理解吧？

接下来有点枯燥，让我们来看看数据类型，虽然枯燥却是很重要的内容。

### VBA 数据类型和变量

编写程序免不了处理各种数据，这些数据有些会储存在各种资源中，当然更多的是储存在变量之中的。所以我们需要了解 VBA 的数据类型，以及如何声明各个类型的变量。

| 数据类型              | 存储空间大小          | 范围                                                                                                                                                                         |
| :-------------------- | :-------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Byte                  | 1 个字节              | 0 到 255                                                                                                                                                                     |
| Boolean               | 2 个字节              | True 或 False                                                                                                                                                                |
| Integer               | 2 个字节              | -32,768 到 32,767                                                                                                                                                            |
| Long(长整型)          | 4 个字节              | -2,147,483,648 到 2,147,483,647                                                                                                                                              |
| Single (单精度浮点型) | 4 个字节              | 负数时从 -3.402823E38 到 -1.401298E-45；正数时从 1.401298E-45 到 3.402823E38                                                                                                 |
| Double (双精度浮点型) | 8 个字节              | 负数时从 -1.79769313486232E308 到 -4.94065645841247E-324；<br>正数时从 4.94065645841247E-324 到 1.79769313486232E308                                                         |
| Currency (变比整型)   | 8 个字节              | 从 -922,337,203,685,477.5808 到 922,337,203,685,477.5807                                                                                                                     |
| Decimal               | 14 个字节             | 没有小数点时为 +/-79,228,162,514,264,337,593,543,950,335，而小数点右边有 28 位数时为 +/-7.9228162514264337593543950335；<br>最小的非零值为 +/-0.0000000000000000000000000001 |
| Date                  | 8 个字节              | 100 年 1 月 1 日 到 9999 年 12 月 31 日                                                                                                                                      |
| Object                | 4 个字节              | 任何 Object 引用                                                                                                                                                             |
| String (变长)         | 10 字节加字符串长度   | 0 到大约 20 亿                                                                                                                                                               |
| String(定长)          | 字符串长度            | 1 到大约 65,400                                                                                                                                                              |
| Variant(数字)         | 16 个字节             | 任何数字值，最大可达 Double 的范围                                                                                                                                           |
| Variant(字符)         | 22 个字节加字符串长度 | 与变长 String 有相同的范围                                                                                                                                                   |
| 用户自定义            | 所有元素所需数目      | 每个元素的范围与它本身的数据类型的范围相同。                                                                                                                                 |

定义变量的方式：

```c
Dim 变量名 As 数据类型
```

定义变量除了可以使用 Dim 语句外，比较常的还有：static 语句，Private 语句，Public 语句。

给变量赋值的方式：

```c
变量名 = 值
```

定义一个常量：

```c
Const 常量名 As 数据类型 ＝ 常量的值
```

### 逻辑判断语句

If 语句就不多说啦。

```c
if  逻辑表达式 then
    内容
ElseIf 逻辑表达式 then
    内容
Else
    内容
end if
```

For 语句其实和其他语言一样，就是要注意一下步长，就是 Java 的 for 的第三段，循环结束后对循环变量的操作。

```c
For 循环变量＝初值 to 终值 step 步长
     循环体1
    [exit for]
    循环体2
next 循环变量
```

For Each 也不必多说。

```c
For Each 元素变量 In 对象集合或数组名称
      语句块1
      [Exit For]
      语句块2
next 元素变量
```

下面是 While 语句。

```c
Do While 循环条件
      语句块1
     [Exit Do]
      语句块2
Loop
```

```c
Do
    语句块1
   [Exit Do]
    语句块2
Loop While 循环条件
```

有点匆忙，是因为我觉得没必要用太多篇幅介绍了，到这里我们已经了解到了大部分我们需要的 VBA 基础了。

我们知道了数据类型，怎么定义变量，给变量赋值，如何使用逻辑判断和循环，我们已经可以写出实用的 VBA 小程序了。或许你还觉得我们缺少对 Excel 元素的认识？没关系，如果你想要的效果你不知道用什么对象的话，录制宏手动操作一遍，你就知道了！

我们做个小例子。

### 尝试使用 VBA

在说 VBA 基本实现的时候我们举得那个小例子，我们再次升级一下，我们在 sheet 里放两个按钮，其中一个点击写书据到当前 sheet，另一个用来清除这些数据。想想该怎么写，不知道操作什么？录制宏帮助你排忧解难！

不过我们先来看看怎么放置按钮在页面上吧。我们点开开发工具页面，点击插入，选择第一个按钮工具。

![设置按钮](/img/memo-vba/set-button.gif)

再想放置按钮的地方拉出一个按钮，这时一般会弹出指定宏的界面，当然我们也可以之后再设置。

![指定宏](/img/memo-vba/set-macro.gif)

（这里我已经准备好了要使用的宏）

我再贴一次写书据的方法：

```c
Sub Test()
    With ActiveSheet
        .Cells(1, 1).Value = "姓名"
        .Cells(2, 1).Value = "张三"
        .Cells(3, 1).Value = "李四"
        .Cells(4, 1).Value = "王五"
        .Cells(5, 1).Value = "欧阳"
        .Cells(6, 1).Value = "南宫"
        .Cells(7, 1).Value = "小林"
    End With
    ActiveSheet.Range("A1").AutoFilter Field:=1, Criteria1:=Array("李四", _
        "南宫", "欧阳", "王五", "张三"), Operator:=xlFilterValues

End Sub
```

根据我们的需求还需要一个清除数据的方法：

```c
Sub clear()
    Dim i As Integer
    For i = 1 To 7
        ActiveSheet.Cells(i, 1).Value = ""
    Next i
    ActiveSheet.AutoFilterMode = False
End Sub
```

我们在 sheet 中放置两个按钮，并且指定这两个宏给按钮。大概是下面这个样子。

![放置按钮](/img/memo-vba/put-button.gif)

（样式就不用管啦，演示一下而已）

下面是个动图，看看效果。

![演示效果](/img/memo-vba/show-usage.gif)

一个最简单的例子就这样完成了。

想了解更多？之后想起来再写吧！今天困咯。
