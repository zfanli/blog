---
title: Oracle æ•°æ®åº“ SQL æ€§èƒ½è°ƒä¼˜å®è·µç¬”è®°
subtitle: äº¿çº§æ•°æ®é‡ä¸‹ Oracle æ•°æ®åº“ SQL æ€§èƒ½è°ƒä¼˜åˆçº§è§£å†³æ–¹æ¡ˆã€‚
date: 2018-12-31 19:54:38 +8
lastUpdateTime: 2019-01-08 17:57:00 +8
tags:
  - Oracle
  - SQL
  - Database
  - BigDate
---

> ETLï¼š Extract-Transform-Loadï¼Œä¸€ä¸ªæ•°æ®æ¸…æ´— âœ¨ çš„è¿‡ç¨‹ã€‚

ç›®å‰é¡¹ç›®æ­£åœ¨æ„å»ºä¸€ä¸ª ETL ç³»ç»Ÿï¼Œåšæ•°æ®æ¸…æ´— âœ¨ã€‚åˆ°ç°åœ¨å·²ç»æ‹¿åˆ°â€œçœŸå®æ•°æ®â€åœ¨åšæœ€åçš„çº¿ä¸Šç¯å¢ƒæµ‹è¯•ã€‚

åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å‡ ä¸ªæ€§èƒ½ä¸Šæœ‰é—®é¢˜çš„ SQLï¼Œè¿™ç¯‡æ–‡ç« å¯¹è§£å†³è¿™äº›æ€§èƒ½é—®é¢˜çš„è¿‡ç¨‹å’Œæ–¹æ³•åšä¸€ä¸ªç¬”è®°ã€‚ä¸è¿‡åœ¨è¿›å…¥æ­£æ–‡ä¹‹å‰ï¼Œæˆ‘æƒ³è¯´ä¸€ä¸‹é—®é¢˜å‡ºç°çš„åŸå› ã€‚

- è®¾è®¡æ—¶ä¸æ¸…æ¥šè¡¨çš„æ•°æ®è§„æ¨¡ï¼Œæœªè€ƒè™‘æ€§èƒ½ä¸Šçš„å½±å“
- å¼€å‘æ—¶è¿‡äºæ³¨é‡éµä»è®¾è®¡ï¼Œå†™æ³•æ²¡æœ‰è€ƒè™‘æ€§èƒ½ä¼˜åŒ–
- æµ‹è¯•ä¸­æ•°æ®é‡å°‘ï¼Œä½“ç°ä¸å‡ºæ¥é—®é¢˜

å…¶æ ¹æœ¬åŸå› è¿˜æ˜¯åœ¨è®¾è®¡é˜¶æ®µçš„ç–å¿½ï¼Œè®¾è®¡ ETL ç³»ç»ŸæŒæ¡æ¯å¼ è¡¨çš„æ•°æ®è§„æ¨¡ä¹Ÿæ˜¯éå¸¸é‡è¦çš„äº‹æƒ…ï¼Œæœ‰åŠ©äºé’ˆå¯¹æ€§çš„ä¼˜åŒ–æŸäº›ä»»åŠ¡ï¼Œä¼˜åŒ–æ—¶é—´åˆ†é…ã€‚

---

### å†™åœ¨å‰é¢

ç¯‡å¹…ç•¥é•¿ï¼Œä¸»è¦æ˜¯æƒ³å¯¹é¡¹ç›®ä¸Šæœ€è¿‘è§£å†³çš„ä¸€äº› SQL æ€§èƒ½é—®é¢˜åšä¸€ä¸ªç¬”è®°ã€‚ç¬”è®°åŒ…æ‹¬é—®é¢˜å‡ºç°çš„åŸå› ï¼Œè§£å†³çš„è¿‡ç¨‹ä»¥åŠç»“æœï¼Œæœ€ååŠ¨æ‰‹åšä¸ªå†ç°å’ŒéªŒè¯ã€‚ä¸‹é¢æ˜¯è¿™ç¯‡æ–‡ç« çš„ road mapã€‚

- æ¦‚æ‹¬éƒ¨åˆ†
  - ç½—åˆ—å…·ä½“æ–¹æ³•
  - æ¦‚æ‹¬è°ƒä¼˜æ€è·¯
  - ç»“åˆæ¡ˆä¾‹
  - å°‘é‡ä»£ç ç¤ºä¾‹
- å®è·µéƒ¨åˆ†
  - é‡ç°æ¡ˆä¾‹
  - å¥—ç”¨è§£å†³æ–¹æ¡ˆ
  - å¤§é‡ä»£ç ç¤ºä¾‹
  - ä»æ„å»ºç¯å¢ƒå¼€å§‹

### è§£å†³æ–¹æ¡ˆ

å…·ä½“è¿ç”¨äº†çš„è§£å†³æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- æ·»åŠ ç´¢å¼•ï¼ˆé’ˆå¯¹è¡¨è¯»å–å¤§äºå†™å…¥çš„åœºæ™¯ï¼‰
- ä¼˜åŒ–å’Œæ”¹å†™ç›¸åŒé€»è¾‘ï¼ˆè®©å…¶ä½¿ç”¨ç´¢å¼•ï¼‰
- åˆ‡å‰²å¤æ‚è¯­å¥åˆ°å¤šä¸ªç®€å•è¯­å¥ï¼ˆä¸»è¦ä¼˜åŒ–å†…å­˜å ç”¨ï¼‰
- ä½¿ç”¨ `merge` ä»£æ›¿ `update`
- ä¿®æ”¹ä¸šåŠ¡é€»è¾‘ï¼ˆæ•ˆæœå¥½ä½†æ²¡æœ‰æ™®é€‚æ€§ï¼‰

æœªè¿ç”¨åˆ°å®é™…é—®é¢˜ä¸Šï¼Œä½†æ˜¯è¯•éªŒè¿‡æœ‰æ•ˆçš„æ–¹æ¡ˆæœ‰ä¸‹é¢è¿™äº›ï¼š

- ä½¿ç”¨ `partition` è¡¨åˆ†åŒºæé«˜æ•ˆç‡
- ä½¿ç”¨ `/*+ APPEND */` é…åˆ `nologging` å‡å°‘æ—¥å¿—æé«˜å†™å…¥æ•ˆç‡
- è¡¨å‹ç¼©ï¼Œåˆ©ç”¨ç©ºé—² CPU å‡å°‘ IO æ—¶é—´

### ä¼˜åŒ–æ€è·¯

ä¸€èˆ¬é‡åˆ°é—®é¢˜æ—¶å…ˆå°è¯•æœ€ç®€å•çš„ç´¢å¼•æ³•ã€‚

#### é…åˆæ‰§è¡Œè®¡åˆ’åˆ†æ SQL å®šä½é—®é¢˜

æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’æœ€å¥½çš„æ–¹å¼æ˜¯æ‰“å¼€ `autotrace`ï¼Œæ‰§è¡Œä¸‹é¢è¯­å¥ä¹‹åï¼Œæ¯æ¡ SQL å°†ä¼šè¿”å›å®é™…çš„æ‰§è¡Œè®¡åˆ’å¯ä¾›åˆ†æã€‚å‰ææ˜¯éœ€è¦ DBA æƒé™ã€‚

```sql
set autotrace on;
```

ä½†å¦‚æœä½ å’Œæˆ‘ä¸€æ ·æ²¡æœ‰ DBA æƒé™ï¼Œé‚£å°±åªèƒ½çœ‹æ¨æµ‹çš„å®è¡Œè®¡åˆ’äº†ã€‚åœ¨ SQL Developer é‡Œé€‰ä¸­ä¸€æ¡ SQL æŒ‰ `F10` å¯ä»¥æŸ¥çœ‹ç²¾ç®€ç‰ˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œå¥½å¤„æ˜¯æ–¹ä¾¿å¿«æ·ã€‚

> æˆ‘ä½¿ç”¨çš„ Oracle SQL Developer ç‰ˆæœ¬ï¼š3.2.20.10

é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå¯æŸ¥çœ‹ä¿¡æ¯æ›´å¤šçš„è§£é‡Šè®¡åˆ’è¯­å¥ï¼Œå†™åœ¨æ¯æ¡ SQL å‰é¢ï¼ŒæŸ¥çœ‹**æ¨æµ‹çš„æ‰§è¡Œè®¡åˆ’**ã€‚æ³¨æ„ï¼Œé‡ç‚¹æ˜¯â€œæ¨æµ‹â€ï¼Œç”±äºæ²¡æœ‰ DBA æƒé™ï¼Œè¿™ç§è§£é‡Šè®¡åˆ’ä»…æ˜¯åŸºäºç»Ÿè®¡ä¿¡æ¯åˆ†æå‡ºæ¥çš„â€œGuessâ€ï¼Œå¹¶éå®é™…é‡‡ç”¨çš„æ‰§è¡Œè®¡åˆ’ã€‚åŒç†ä¸Šé¢çš„ `F10` ä¹Ÿæ˜¯ä»…ä¾›å‚è€ƒçš„ï¼Œä¸€èˆ¬ä¿è¯è¡¨çš„ç»Ÿè®¡ä¿¡æ¯åˆ†ææ­£ç¡®çš„è¯è¿˜æ˜¯æŒºå‡†çš„ã€‚

```sql
explain plan for
  -- æ¥å…·ä½“çš„è¯­å¥
  select 1 from dual;

-- ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æ¥æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
select plan_table_output from table(dbms_xplan.display())ï¼›
```

å‚è€ƒæ–‡æ¡£ï¼š

- [Tuning SQL\*Plus - Tracing Statements](https://docs.oracle.com/database/121/SQPUG/ch_eight.htm#SQPUG534)
- [Database SQL Language Reference - EXPLAIN PLAN](https://docs.oracle.com/database/121/SQLRF/statements_9010.htm#SQLRF01601)
- [Database PL/SQL Packages and Types Reference - DBMS_XPLAN](https://docs.oracle.com/database/121/ARPLS/d_xplan.htm#ARPLS378)

#### æ·»åŠ ç´¢å¼•å¹¶é…åˆä½¿ç”¨ `hint` è®©ä¸èµ°ç´¢å¼•çš„éƒ¨åˆ†å¼ºåˆ¶èµ°ç´¢å¼•çœ‹æ•ˆæœ

å°è¯•ç»™æ²¡æœ‰èµ°ç´¢å¼•çš„åœ°æ–¹åˆ›å»ºç›¸åº”çš„ç´¢å¼•ã€‚

```sql
create index index_name on table_name (fields...);
```

å¦‚æœåˆ›å»ºäº†ç›¸åº”ç´¢å¼•ï¼Œä½†å› ä¸ºä¼˜åŒ–å™¨åˆ¤æ–­ä¸å»èµ°ç´¢å¼•çš„æƒ…å†µï¼Œå¯ä»¥ç”¨ `hint` å¼ºåˆ¶èµ°ç´¢å¼•çœ‹çœ‹æ•ˆæœã€‚`index()` çš„æ‹¬å·é‡Œé¢ä¸€èˆ¬å¡«ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºè¡¨åï¼Œç¬¬äºŒä¸ªæ˜¯ç´¢å¼•åã€‚

```sql
select /*+ index(target_table target_index) */
  fields...
from target_table;
```

> âš ï¸ åˆ›å»ºç´¢å¼•çš„ä»£ä»·æ˜¯ä¼šå æ›´å¤šçš„å‚¨å­˜ç©ºé—´ï¼Œå¹¶ä¸”æ¯æ¬¡æ’å…¥æ•°æ®çš„æ—¶å€™éƒ½ä¼šå¯¹ç´¢å¼•è¿›è¡Œç»´æŠ¤ï¼Œå¯¹å†™å…¥é€Ÿåº¦äº§ç”Ÿå½±å“ã€‚

å‚è€ƒæ–‡æ¡£ï¼š

- [Database SQL Language Reference - INDEX Hint](https://docs.oracle.com/database/121/SQLRF/sql_elements006.htm#BABEFDFC)
- [Database SQL Language Reference - USE_NL Hint](https://docs.oracle.com/database/121/SQLRF/sql_elements006.htm#BABDDFHC)

**ä¾‹å­ ğŸŒ°1**

æ·»åŠ ç´¢å¼•ä¼˜åŒ–çš„æ —å­ã€‚

| è¾“å…¥è¡¨     |      æ•°æ®é‡ |
| ---------- | ----------: |
| é¡¾å®¢è¡¨     | 138,066,840 |
| é¡¾å®¢ä¿¡æ¯è¡¨ | 145,586,869 |
| ä¸šåŠ¡è¡¨     |      16,220 |

è¾“å‡ºæ•°æ®é‡ä¸ºï¼š7,442ã€‚

| &nbsp;     | è¿è¡Œæ—¶é—´ |
| ---------- | -------- |
| åˆ›å»ºç´¢å¼•å‰ | 2:02:27  |
| åˆ›å»ºç´¢å¼•å | 0:01:17  |

è¿™ä¸ªä¾‹å­ä¸­ï¼Œè™½ç„¶æœ€ç»ˆè¾“å‡ºç»“æœä»…ä¸º 7 åƒè¡Œï¼Œä½†ç”±äº `é¡¾å®¢è¡¨` å’Œ `é¡¾å®¢ä¿¡æ¯è¡¨` éƒ½æ˜¯æ‹¥æœ‰ç™¾æ¥ä¸ªå­—æ®µçš„å¤§è¡¨ï¼Œå…¨è¡¨æ£€ç´¢éå¸¸åƒåŠ›ã€‚ä¼˜åŒ–çš„æ–¹æ³•æ˜¯å¯¹æ‰€æœ‰æŸ¥è¯¢æ¡ä»¶åˆ›å»ºç´¢å¼•ï¼Œæ•ˆæœå¾ˆæ˜æ˜¾ã€‚

**ä¾‹å­ ğŸŒ°2**

æ•°æ®é‡å¤§çš„æƒ…å†µç´¢å¼•ä¼˜åŒ–çš„æ —å­ã€‚

| è¾“å…¥è¡¨ |      æ•°æ®é‡ |
| ------ | ----------: |
| é¡¾å®¢è¡¨ | 138,066,840 |
| ä¸šåŠ¡è¡¨ |  43,850,757 |
| ç§ç±»è¡¨ |          16 |

è¾“å‡ºæ•°æ®é‡ä¸ºï¼š43,599,931ã€‚

| &nbsp;     | è¿è¡Œæ—¶é—´ |
| ---------- | -------- |
| åˆ›å»ºç´¢å¼•å‰ | 3:10:17  |
| åˆ›å»ºç´¢å¼•å | 1:12:23  |

è¿™ä¸ªä¾‹å­ç”±äºå››åƒä¸‰ç™¾ä¸‡çš„è¾“å‡ºæ•°æ®é‡çš„é™åˆ¶ï¼Œä»… IO æ“ä½œéƒ½ä¼šèŠ±è´¹ä¸å°‘æ—¶é—´ï¼Œæ·»åŠ ç´¢å¼•åæŠŠæŸ¥è¯¢éƒ¨åˆ†çš„æ—¶é—´å‡å°‘äº†ä¸å°‘ï¼Œæœ€ç»ˆç»“æœæ˜¯ 72 åˆ†é’Ÿï¼Œè¿˜ç®—å¯ä»¥æ¥å—çš„ç»“æœã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œåˆ°è¿™é‡Œå¾ˆå¤šé—®é¢˜éƒ½å¯ä»¥å¾—åˆ°è§£å†³ï¼Œå°¤å…¶æ˜¯è¯»å¤§è¡¨çš„åœºæ™¯ï¼Œå¯èƒ½æ…¢å°±æ…¢åœ¨æ²¡æœ‰ç´¢å¼•ä¸Šã€‚å¦‚æœé—®é¢˜è¿˜æ²¡å¾—åˆ°è§£å†³ï¼Œæˆ‘ä»¬å†å¾€åçœ‹ã€‚

#### å¯¹æ— æ³•èµ°ç´¢å¼•çš„éƒ¨åˆ†è¿›è¡Œæ”¹å†™æœ€ç»ˆè®©å…¶èµ°ç´¢å¼•

æŸäº›è¯­å¥çš„å†™æ³•ä¹Ÿä¼šå¯¼è‡´æ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚åœ¨æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ä¸­å°±æœ‰ä¸€ä¸ªï¼Œä½¿ç”¨äº† `in` å…³é”®å­—å¯¼è‡´æ— æ³•èµ°ç´¢å¼•ï¼Œæœ€ç»ˆé€šè¿‡æ”¹å†™ SQL å°†å…¶è½¬åŒ–ä¸º `inner join` æ‰å¾—ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚ä»£ç æ— æ³•ç›´æ¥è´´å‡ºæ¥ï¼Œåšä¸ªé‡ç°çš„ä¾‹å­ï¼Œå¤§è‡´å¦‚ä¸‹ã€‚

```sql
-- åŸå§‹è¯­å¥
select
  field_names...
from
  table_a a
where
  a.the_key in (select the_key from table_b);

-- ä¿®æ”¹åè¯­å¥
select
  field_names...
from
  table_a a
inner join
  table_b b
on
  a.the_key = b.the_key;
```

**ä¾‹å­ ğŸŒ°3**

æ”¹å†™ä½¿å…¶ä½¿ç”¨ç´¢å¼•çš„æ —å­ã€‚

| è¾“å…¥è¡¨       |      æ•°æ®é‡ |
| ------------ | ----------: |
| é¡¾å®¢ä¿¡æ¯è¡¨ 1 | 145,586,869 |
| é¡¾å®¢ä¿¡æ¯è¡¨ 2 | 294,225,728 |
| é¡¾å®¢ä¿¡æ¯è¡¨ 3 | 261,309,380 |
| é¡¾å®¢ä¿¡æ¯è¡¨ 4 | 140,379,648 |

è¾“å‡ºæ•°æ®é‡ä¸ºï¼š149ã€‚ä½†æ˜¯å¯¹ä¸Šé¢å››å¼ è¡¨åšäº†ä¸åŒç¨‹åº¦çš„æ›´æ–°ã€‚

| &nbsp; | è¿è¡Œæ—¶é—´ |
| ------ | -------- |
| ä¿®æ”¹å‰ | 1:58:48  |
| ä¿®æ”¹å | 0:00:03  |

è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒSQL åŒ…å«ä¸€è¿ä¸²çš„ `with as` è¯­å¥ï¼Œå…¶ä¸­ä¸€å—è¯­å¥çš„æŸ¥è¯¢æ¡ä»¶é‡Œé¢å­˜åœ¨ä¸¤ä¸ª `in` å…³é”®å­—ï¼Œä½†æ˜¯ `in` è¯­å¥é‡Œé¢éƒ½æ˜¯äº¿çº§çš„å¤§è¡¨ï¼Œé€ æˆä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œæœ€ç»ˆé€šè¿‡å°†å…¶æ”¹å†™ä¸ºä¸¤ä¸ª `inner join` å¾—åˆ°æ”¹å–„ã€‚

ä¼˜åŒ–ç´¢å¼•å½“ç„¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„é—®é¢˜ï¼Œæ‰€ä»¥å¦‚æœç´¢å¼•è§£å†³ä¸äº†é—®é¢˜ï¼Œå°±è¦ç»“åˆæ›´å¤šä¿¡æ¯æ¥åˆ†æå®šä½é—®é¢˜æ‰€åœ¨äº†ã€‚

#### åˆ†å‰²å¤æ‚ SQL åˆ°å¤šä¸ªç®€å• SQLï¼Œå‡å°‘å†…å­˜å æœ‰æ—¶é—´

å¦‚æœé‡åˆ°å†…å­˜é—®é¢˜ï¼Œå¦‚ PAG å†™æ»¡äº†ï¼Œæˆ–è€… UNDO ç©ºé—´å†™çˆ†äº†ï¼Œè€ƒè™‘è¿™ä¸ªæ–¹æ¡ˆã€‚

å­æŸ¥è¯¢åµŒå¥—è¿‡å¤šä¼šåŠ å‰§å†…å­˜èµ„æºçš„æ¶ˆè€—ï¼Œä¹Ÿä¼šæ‹‰é•¿å†…å­˜å æœ‰æ—¶é—´ã€‚è¿™æ—¶å¯ä»¥è€ƒè™‘åˆ†å‰²å¤æ‚çš„ SQL è¯­å¥ï¼ŒåŠ å…¥å‡ ä¸ªä¸­é—´è¡¨æ¥ç¼“å’Œå†…å­˜çš„è´Ÿæ‹…ã€‚æ¯•ç«Ÿå¯¹äºç³»ç»Ÿç¨³å®šæ€§æ¥è¯´ï¼Œå¢åŠ çš„é‚£ç‚¹å‚¨å­˜ç©ºé—´æ€»æ˜¯å¾®ä¸è¶³é“çš„ã€‚

#### ä½¿ç”¨ `merge` ä»£æ›¿ `update` ç¼©çŸ­æ›´æ–°æ“ä½œæ—¶é—´ï¼Œå‡å°‘å†…å­˜å æœ‰æ—¶é—´

`merge` æ˜¯ä¸€ä¸ªå¯ä»¥åŒæ—¶è¿›è¡Œæ’å…¥å’Œæ›´æ–°çš„èšåˆæ“ä½œï¼Œè€Œåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­å·²ç»æ”¯æŒå•ç‹¬çš„æ›´æ–°å’Œæ’å…¥æ“ä½œã€‚ç»è¿‡æˆ‘ä»¬çš„æµ‹è¯•å‘ç°ï¼Œç”¨ `merge` æ¥è¿›è¡Œæ›´æ–°æ“ä½œæ‰§è¡Œæ•ˆç‡æ¯” `update` è¦å¥½ï¼Œæ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ç”šè‡³ `merge` çš„æ•ˆç‡é«˜å‡ºå‡ å€ã€‚`merge` ç¤ºä¾‹å¦‚ä¸‹ã€‚

```sql
merge into table_a a using table_b b
on (a.pk = b.pk)
when matched then     -- å½“æ»¡è¶³ on é‡Œçš„æ¡ä»¶æ‰§è¡Œæ›´æ–°è¯­å¥ï¼Œå¯çœç•¥
  update set a.flag = b.flag
when not matched then -- å½“ä¸æ»¡è¶³ on é‡Œçš„æ¡ä»¶æ‰§è¡Œæ’å…¥è¯­å¥ï¼Œå¯çœç•¥
  insert (a.pk, a.flag, a.other_fields)
  values (b.pk, b.flag, b.other_fields);
```

å°è¯•ç”¨æ›´æœ‰æ•ˆç‡çš„å†™æ³•æ”¹å†™ SQLï¼Œå‡å°‘å†…å­˜å æœ‰æ—¶é—´ï¼Œä¹Ÿæ˜¯ä¼˜åŒ–å†…å­˜å‡ºé—®é¢˜çš„ä¸€ç§æ–¹æ³•ã€‚ç›®å‰æˆ‘ä»¬é‡åˆ°å¸¦æŠ¥é”™ä¿¡æ¯çš„é—®é¢˜è¿˜åªæœ‰å†…å­˜é—®é¢˜ä¸€ä¸ªã€‚

å‚è€ƒæ–‡æ¡£ï¼š

- [Database SQL Language Reference - MERGE](https://docs.oracle.com/database/121/SQLRF/statements_9017.htm#SQLRF01606)

**ä¾‹å­ ğŸŒ°4**

åˆ†å‰²å¤æ‚ SQL å¹¶ä¸”ä½¿ç”¨ `merge` ä»£æ›¿ `update` çš„æ —å­ã€‚

| è¾“å…¥è¡¨     |      æ•°æ®é‡ |
| ---------- | ----------: |
| é¡¾å®¢ä¿¡æ¯è¡¨ | 145,586,869 |
| ä¸šåŠ¡è¡¨     |  48,094,285 |

åˆ†å‰²åæ’å…¥åˆ°ä¸­é—´è¡¨çš„æ•°æ®é‡ã€‚

| ä¸­é—´è¡¨   |     æ•°æ®é‡ |
| -------- | ---------: |
| ä¸­é—´è¡¨ 1 | 48,067,928 |
| ä¸­é—´è¡¨ 2 |     11,051 |

è¾“å‡ºæ•°æ®é‡ä¸º 11,051ï¼Œå¹¶ä¸”æ›´æ–°é¡¾å®¢ä¿¡æ¯è¡¨å¯¹åº”å¯¹æ•°æ®ã€‚

| &nbsp;             | è¿è¡Œæ—¶é—´ |
| ------------------ | -------- |
| ä¿®æ”¹å‰             | æŠ¥é”™     |
| ä¿®æ”¹åï¼ˆæ¸¸æ ‡ï¼‰     | 1:17:31  |
| ä¿®æ”¹åï¼ˆä¸ç”¨æ¸¸æ ‡ï¼‰ | 0:09:51  |

è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¿®æ”¹å‰ç”±äºæ•°æ®é‡åŸå› è¿è¡Œäº†å››äº”ä¸ªå°æ—¶ä¹‹åæŠ¥é”™äº†ã€‚ç±»ä¼¼äºä¸‹é¢è¿™ä¸ªæŠ¥é”™ä¿¡æ¯ã€‚åŸå› æ˜¯ UNDO ç©ºé—´è¢«å†™çˆ†äº†ã€‚

> ORA-01555: snapshot too old: rollback segment number 1 with name "\_SYSSMU1\$" too small

ä¼˜åŒ–çš„æ–¹æ³•æ˜¯åˆ†å‰²å¤æ‚ SQL åˆ°å¤šä¸ªè¯­å¥ï¼Œä¸­é—´åŠ å…¥ä¸­é—´è¡¨æ¥è¡”æ¥ï¼Œå¹¶ä¸”ä½¿ç”¨ `merge` ä»£æ›¿ `update` å‡å°‘å†…å­˜å æœ‰æ—¶é—´ã€‚

æœ€ç»ˆæ–¹æ¡ˆä¿®æ”¹äº†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨æ¸¸æ ‡è¿›è¡Œåˆ†æ‰¹å¤„ç†ï¼Œæ¯æ¬¡ 1000 æ•°æ® `commit` ä¸€æ¬¡ï¼Œå‡å°‘å†…å­˜è´Ÿæ‹…ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬è€—æ—¶å¤ªé•¿äº†ï¼Œplsql å¼•æ“å’Œ SQL å¼•æ“æ¥å›åˆ‡æ¢é¢‡ä¸ºè´¹æ—¶ã€‚

å¦å¤–ä¸€ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨ `insert select` æ’å…¥æ•°æ®ï¼Œè™½ç„¶å†…å­˜ä½¿ç”¨ç‡å˜é«˜ï¼Œä½†é€Ÿåº¦æå‡æ˜¾è‘—ï¼Œä¸”ååˆ†é’Ÿçš„å†…å­˜å æœ‰æ—¶é—´åœ¨æ¥å—èŒƒå›´å†…ã€‚æœ€ç»ˆä½¿ç”¨äº†è¿™ä¸ªç‰ˆæœ¬ã€‚

#### ä»ä¸šåŠ¡çš„è§’åº¦ä¸Šä¼˜åŒ–

å¦‚æœä¸Šè¿°æ–¹æ¡ˆéƒ½æ²¡æœ‰å¤ªå¤§æ•ˆæœï¼Œé‚£ä¹ˆå¯èƒ½ä½ çš„ç“¶é¢ˆå‡ºç°åœ¨ IO æ“ä½œæˆ–è€…æ˜¯ `merge` å’Œ `update` ç­‰éå¸¸æ˜‚è´µåˆä¸å¯é¿å…çš„æ“ä½œä¸Šäº†ï¼Œè¿™æ—¶å°±å¯ä»¥å°è¯•ä»ä¸šåŠ¡çš„è§’åº¦ä¸Šä¼˜åŒ–ã€‚

ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘é£é™©å¤§ï¼Œä¸”èƒ½å¦æˆåŠŸè¿˜æ˜¯éšç¼˜çš„ã€‚ä¸è¿‡å¦‚æœæˆåŠŸï¼Œæ•ˆæœå°±ä¼šå¾ˆç¾å¥½ã€‚ä¸€èˆ¬ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘å¯ä»¥åšä¸‹é¢çš„è€ƒè™‘ã€‚

#### æ•°æ®æ›´æ–°çš„åœºæ™¯ï¼Œå¯ä»¥ç»“åˆæ•°æ®åˆ†æï¼Œå¯»æ‰¾ä¸šåŠ¡é€»è¾‘çš„ä¼˜åŒ–ç‚¹

æ›´æ–°æ˜¯ç›¸å¯¹æ¥è¯´æ¯•ç«Ÿæ˜‚è´µçš„æ“ä½œï¼Œç»“åˆæ•°æ®åˆ†æè€ƒè™‘æ˜¯å¦èƒ½å‡å°‘æ›´æ–°é‡å°†æœ‰åŠ©äºæé«˜æ•ˆç‡ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œæœ‰ä¸€ä¸ªä¸šåŠ¡è¦æ±‚æŠ½å–ä¸€æ‰¹æ•°æ®ç»Ÿä¸€åŠ ä¸Šä¸€ä¸ª Flagï¼Œè®¾ä¸º `00`ï¼Œç„¶åæ ¹æ®ä¸€å †æ¡ä»¶ç­›é€‰å‡ºå…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®æŠŠ Flag æ›´æ–°ä¸º `99`ã€‚åœ¨è¿™ä¸ªä¸šåŠ¡ä¸Šå‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼Œå…¶åŸå› æ˜¯éœ€è¦æ›´æ–°ä¸º `99` çš„æ•°æ®å¤ªå¤šäº†ã€‚

å½“çŸ¥é“æ€§èƒ½é—®é¢˜çœŸæ­£çš„åŸå› ï¼Œäº‹æƒ…å°±ä¼šç®€å•å¾ˆå¤šã€‚åœ¨è¿™ä¸ªæ —å­ ğŸŒ° ä¸­ï¼Œç”±äºéœ€è¦æ›´æ–°çš„æ•°æ®è¶…è¿‡äº†å¤„ç†æ•°æ®çš„ä¸€åŠä»¥ä¸Šï¼Œäºæ˜¯ï¼Œå°†å…¶åˆå§‹åŒ–ä¸º `99`ï¼Œç„¶åå°†é‚£äº›ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®æ‰¾å‡ºæ¥æ›´æ–°ä¸º `00` å¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ›´æ–°çš„æ•°æ®é‡ï¼Œæé«˜æ•ˆç‡ã€‚

**ä¾‹å­ ğŸŒ°5**

ä¸Šé¢çš„æ —å­å…¶å®æ˜¯ä¸€ä¸ªå­˜åœ¨çš„æ¡ˆä¾‹ã€‚

| è¾“å…¥è¡¨     |      æ•°æ®é‡ |
| ---------- | ----------: |
| é¡¾å®¢è¡¨     | 138,066,840 |
| é¡¾å®¢ä¿¡æ¯è¡¨ | 145,586,869 |

è¾“å‡ºæ•°æ®é‡ä¸ºï¼š13,764ã€‚å¹¶ä¸”é€”ä¸­åšäº†å‡ æ¬¡ä¸åŒç¨‹åº¦çš„æ›´æ–°ã€‚

| &nbsp; | è¿è¡Œæ—¶é—´ |
| ------ | -------- |
| ä¿®æ”¹å‰ | 5:05:53  |
| ä¿®æ”¹å | 0:01:00  |

é€šè¿‡åå‘æ›´æ–°å‡å°‘äº†å¤§é‡æ›´æ–°æ“ä½œï¼Œå¤§å¹…åº¦æé«˜äº†æ‰§è¡Œæ•ˆç‡ã€‚

#### åˆ†æå­æŸ¥è¯¢ï¼Œå°†é‡å¤çš„æŸ¥è¯¢å›ºåŒ–åˆ°ä¸€å¼ å·¥ä½œè¡¨ä¸­ï¼Œå‡å°‘åå¤æŸ¥è¯¢

å‡å°‘ IO æ°¸è¿œéƒ½æ˜¯ä¼˜åŒ–çš„é¦–é€‰æ–¹æ¡ˆï¼Œä½†å®é™…ä¸Šå¯èƒ½ä»»åŠ¡çš„æ¯ä¸€æ­¥ IO éƒ½æ˜¯ä¸å¯é¿å…çš„ã€‚ä½†æ˜¯ä¸åŒä»»åŠ¡ä¹‹é—´å¯èƒ½ä¼šæœ‰é‡å¤çš„é€»è¾‘ï¼Œå°è¯•åˆ†æç±»ä¼¼çš„ä¸šåŠ¡ï¼Œæ‰¾åˆ°åå¤æŸ¥è¯¢çš„æ•°æ®ï¼Œå°†å…¶ä¸´æ—¶å›ºåŒ–åˆ°å·¥ä½œè¡¨ï¼Œå‡å°‘ IOï¼Œæé«˜æ•ˆç‡ã€‚

#### é’ˆå¯¹å¤šæ­¥éª¤çš„ä¸šåŠ¡ï¼Œæå–æ‰€æœ‰ç­›é€‰æ¡ä»¶åˆ°ç¬¬ä¸€æ­¥ï¼Œç¼©å°æ•°æ®èŒƒå›´

è®¾è®¡çš„æ—¶å€™æœ‰äº›åœ°æ–¹ç”±äºé€»è¾‘çš„è¿è´¯æ€§ï¼Œä¼šå°†ç­›é€‰æ¡ä»¶åˆ†å¸ƒåˆ°å¤šä¸ªæ­¥éª¤ä¸Šï¼Œæ¥è®©è®¾è®¡æ›´å¯è¯»ï¼Œæ›´å¥½ç†è§£ã€‚

è¿˜æ˜¯ä¸¾ä¾‹å­æ¥è¯´ï¼Œå‡è®¾æœ‰ä¸€ä¸ªä¸šåŠ¡åˆ†ä¸ºä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ ¹æ®å¤„ç†æ¡ä»¶ç­›é€‰å‡º 4800 ä¸‡æ•°æ®ï¼Œæ”¾åœ¨ä¸€å¼ ä¸­é—´è¡¨é‡Œï¼Œç¬¬äºŒæ­¥ç”¨è¿™å¼ ä¸­é—´è¡¨å…³è”å…¶ä»–è¡¨ï¼Œè¿›ä¸€æ­¥ç­›é€‰å‡º 1 ä¸‡æ¡æ•°æ®ï¼Œæ›´æ–°è¿™äº›æ•°æ®çš„ Flagï¼Œæ›´æ–°çš„æ¡ä»¶æ˜¯åŸæœ¬ä¸º `0` çš„æ›´æ–°ä¸º `1`ï¼ŒåŸæœ¬ä¸º `1` çš„æ›´æ–°ä¸º `0`ã€‚

// SVG

è¿™é‡Œçš„ IO æœ‰ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥è¯»å– 4800 ä¸‡æ•°æ®å†å†™å…¥ 4800 ä¸‡æ•°æ®ï¼Œç¬¬äºŒæ­¥è¯»å– 4800 ä¸‡æ•°æ®ï¼Œç„¶ååœ¨å…¶ä¸­æ‰¾åˆ° 1 ä¸‡æ•°æ®ç”¨æ¥æ›´æ–°ã€‚ä½†æ˜¯æ•´ä½“çœ‹ä¸‹æ¥è¿™ 4800 ä¸‡æ•°æ®å…¶å®è¿˜æ˜¯å­˜åœ¨ä¼˜åŒ–ä½™åœ°çš„ï¼Œå› ä¸ºè¿™ä¸ªä¸šåŠ¡çš„ç¬¬äºŒæ­¥éšè—äº†ä¸€ä¸ªç­›é€‰æ¡ä»¶ï¼ŒFlag çš„å€¼éœ€è¦é™å®šåœ¨ `0` å’Œ `1`ã€‚

è¿™ä¸ªæ¡ä»¶å¦‚æœåœ¨ç¬¬ä¸€æ­¥åŠ å…¥è¿›æ¥ï¼Œé‚£ä¹ˆè¿™ 4800 ä¸‡æ•°æ®å°±èƒ½åœ¨ä¸€å®šç¨‹åº¦å¾—åˆ°å‡å°‘ï¼Œç”±æ­¤åç»­çš„ IO æ“ä½œéƒ½èƒ½å‡è½»éƒ¨åˆ†è´Ÿæ‹…ã€‚

// SVG

#### ä¸€äº›å…¶ä»–çš„è§£å†³æ–¹æ¡ˆ

ä¸Šé¢æ˜¯æœ‰å…·ä½“æ¡ˆä¾‹çš„å®è·µï¼Œä¸‹é¢è¿˜æœ‰ä¸€äº›è¯•éªŒè¿‡æœ‰æ•ˆæœçš„æ–¹æ¡ˆï¼Œä½†æ˜¯ç”±äºä¸€äº›åŸå› æ²¡æœ‰è¿ç”¨åˆ°è¿™æ¬¡é‡åˆ°çš„é—®é¢˜ä¸Šå»ã€‚éƒ½æ˜¯ä¸€äº›æœ‰ä»·å€¼çš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¹Ÿè®°å½•ä¸€ä¸‹ã€‚

#### ä½¿ç”¨ partition è¡¨åˆ†åŒºæé«˜æ•ˆç‡

åˆ›å»ºè¡¨åˆ†åŒºè™½ç„¶æ²¡æœ‰ç”¨æ¥è§£å†³è¿™æ¬¡é‡åˆ°çš„é—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šå½“åˆè®¾è®¡è¡¨çš„æ—¶å€™å·²ç»æ˜¯åšè¿‡åˆ†åŒºçš„äº†ã€‚

è¡¨åˆ†åŒºå…·ä½“çš„ä½œç”¨æ˜¯æ ¹æ®ä¸€å®šæ¡ä»¶å°†ä¸€å¼ å¤§è¡¨åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„ `partition`ï¼Œå¯¹å¤–éƒ¨æ¥è¯´è¿™å¼ è¡¨è¿˜æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä½†æ˜¯ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨åˆ¤æ–­ï¼Œåœ¨ç¬¦åˆæ¡ä»¶çš„æƒ…å†µä¸‹è®¿é—®å¯¹åº”çš„åˆ†åŒºæ¥æé«˜æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨ SQL è¯­å¥ä¸­è¡¨ååé¢æ·»åŠ  `partition(partition_name)` å°å¥æ¥æŒ‡å®šè®¿é—®å“ªä¸ªåˆ†åŒºã€‚

```sql
select count(1) from target_table partition(table_part01);
```

ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´ï¼Œå‡è®¾é¡¾å®¢è¡¨ä¸­æœ‰ä¸¤ç§ç±»å‹çš„é¡¾å®¢ï¼Œ`ä¼ä¸š` é¡¾å®¢å’Œ `ä¸ªäºº` é¡¾å®¢ï¼Œè¿™å¼ è¡¨æœ‰ 1 äº¿æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬æŒ‰ç…§é¡¾å®¢ç±»å‹æ¥ç»™è¡¨è¿›è¡Œåˆ†åŒºï¼Œå¹¶ä¸”åˆšå¥½æ¯ä¸ªåˆ†åŒºæœ‰ 5 åƒä¸‡æ•°æ®çš„è¯ï¼Œè¿™æ—¶å¦‚æœæˆ‘ä»¬æŸ¥è¯¢æŸä¸ª `ä¼ä¸š` é¡¾å®¢çš„æ•°æ®ï¼ŒæŸ¥æ‰¾èŒƒå›´å°±ä¼šä»åŸæœ¬çš„ 1 äº¿æ•°æ®ç›´æ¥é™åˆ° 5 åƒä¸‡æ•°æ®ï¼Œæ•ˆç‡å¯è°“ç›´æ¥æå‡ä¸€å€ã€‚

è¿™ä¸ªä¾‹å­çš„ DDL å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```sql
create table customer (
  id number,
  name varchar2(256),
  customer_type varchar2(20),
  -- other fields
) partition by list (customer_type) (
  partition customer_enterprise values ('enterprise'),
  partition customer_individual values ('individual')
);
```

> âš ï¸ è¡¨åˆ†åŒºä»…åœ¨ä¼ä¸šç‰ˆæœ¬å¯ç”¨ã€‚

å®˜æ–¹æ–‡æ¡£å»ºè®®çš„åº”è¯¥è€ƒè™‘åˆ›å»ºè¡¨åˆ†åŒºçš„åœºæ™¯ï¼š

- è¡¨å ç©ºé—´å¤§äº 2G ä»¥ä¸Šï¼›
- è¡¨åŒ…å«å†å²æ•°æ®ï¼Œå…¸å‹çš„ä¾‹å­æ˜¯æŒ‰ç…§æœˆä»½æ•´ç†çš„æ•°æ®ï¼Œä»…æ›´æ–°å½“å‰æœˆä»½çš„æ•°æ®ï¼Œè€Œå…¶ä»– 11 ä¸ªæœˆçš„æ•°æ®éƒ½æ˜¯åªè¯»çš„ï¼›
- è¡¨çš„å†…å®¹å¿…é¡»åˆ†å¸ƒåˆ°ä¸åŒå­˜å‚¨è®¾å¤‡ä¸Šã€‚

å‚è€ƒæ–‡æ¡£ï¼š

- [VLDB and Partitioning Guide - 2 Partitioning Concepts](https://docs.oracle.com/en/database/oracle/oracle-database/12.2/vldbg/partition-concepts.html#GUID-E849DE8A-547D-4A2E-9324-706CAF574754)

#### å‡å°‘ `UNDO` å’Œ `REDO` æ—¥å¿—æé«˜å†™å…¥æ•ˆç‡

Oracle ä¸­åœ¨æ‰§è¡Œ DML è¯­å¥æ—¶ä¼šäº§ç”Ÿ `UNDO` å’Œ `REDO` æ—¥å¿—æ¥ä¿æŠ¤æ•°æ®çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚`UNDO` æ—¥å¿—ç”¨æ¥åšäº‹åŠ¡çš„å›æ»šï¼Œ`REDO` æ—¥å¿—ç”¨æ¥æ¢å¤äº‹åŠ¡ã€‚ä½†æ˜¯åœ¨å¤§æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¤§é‡çš„æ—¥å¿—ä¼šå¾ˆå¤§ç¨‹åº¦åœ°æ‹‰ä½æ‰§è¡Œæ•ˆç‡ã€‚è¿™æ—¶å¯ä»¥ä½¿ç”¨ `/*+ APPEND */` æ¥å‡å°‘ç”šè‡³ä¸åš `UNDO` æ—¥å¿—ï¼Œé…åˆ `nologging` æ¥å‡å°‘ `REDO` æ—¥å¿—ï¼Œä»¥æ­¤æ¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚

ä½¿ç”¨ `/*+ APPEND */` çš„ SQL è¯­å¥çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ã€‚

```sql
insert /*+ APPEND */ into target_table (
  target_values,
  -- ...
);
```

ä½¿ç”¨ `nologging` æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ä»è¡¨å®šä¹‰ä¸Šè®¾å®šã€‚

```sql
alter table target_table nologging;
```

æˆ–è€…å†™åœ¨ DML è¯­å¥ä¸­ã€‚

```sql
insert /*+ APPEND */ into target_table nologging (
  target_fields...
) values (
  insert_values...
);
```

#### è¡¨å‹ç¼©ï¼Œåˆ©ç”¨ç©ºé—² CPU å‡å°‘ IO æ—¶é—´

ä½œä¸ºæœ€åçš„æ‰‹æ®µï¼Œå‹ç¼©è¡¨ä¹Ÿæ˜¯æå‡æ‰§è¡Œæ•ˆç‡çš„å¤§æ€å™¨ã€‚

å‹ç¼©è¡¨çš„åŸç†æ˜¯ï¼Œç»™ç›¸åŒæ•°æ®åˆ›å»ºå­—å…¸è¡¨ï¼Œæ¯æ¬¡æœ‰ç›¸åŒæ•°æ®è¿›æ¥ï¼Œæ•°æ®åº“å°†ä¸å‚¨å­˜åŸå§‹æ•°æ®ï¼Œè€Œä»…å‚¨å­˜å­—å…¸è¡¨çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå¯¹ DML æœ‰æ•ˆã€‚å¥½å¤„æ˜¯å‹ç¼©äº†è¡¨ç©ºé—´ï¼Œå¤§å¹…å‡å°‘äº† IO æ“ä½œï¼Œä¸è¿‡ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¼šæ˜¾è‘—æé«˜ CPU ä½¿ç”¨ç‡ã€‚

å¯¹æˆ‘ä»¬é¡¹ç›®æ¥è¯´ï¼Œæ•°æ®åº“ä½¿ç”¨ç‹¬ç«‹æœåŠ¡å™¨ï¼ŒCPU ç»å¸¸æ˜¯é—²ç½®çš„ï¼Œæ‰€ä»¥å‹ç¼©è¡¨æ²¡æœ‰å¤ªå¤§è´Ÿæ‹…ï¼Œè¿›è¡Œè¡¨å‹ç¼©åè€Œæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å¯¹äºå·²ç»åˆ›å»ºçš„è¡¨è¿›è¡Œå‹ç¼©ï¼Œä½¿ç”¨ä¸‹é¢çš„è¯­å¥ã€‚

```sql
alter table target_table compress for olpt;
```

è¦åœ¨åˆ›å»ºè¡¨æ—¶è®©è¡¨ä½¿ç”¨å‹ç¼©ï¼Œä½¿ç”¨ä¸‹é¢å¯¹è¯­å¥ã€‚

```sql
create table table_name (
  fields...
) compress for olpt;
```

#### Tips

å¤šæ¬¡è¿›è¡Œç›¸åŒçš„æ“ä½œä¼šå¯¼è‡´æ•°æ®åº“ä½¿ç”¨ç¼“å­˜ï¼Œå¯¼è‡´è°ƒä¼˜ç»“æœå¯èƒ½ä¸å‡†ç¡®ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è¯­å¥æ¸…ç©ºç¼“å­˜ã€‚å‰ææ˜¯éœ€è¦ DBA æƒé™ï¼Œå¾ˆå¯æƒœæˆ‘æ²¡æœ‰æƒé™ï¼Œæ‰€ä»¥æˆ‘ç”¨ä¸äº†...

```sql
alter system flush buffer_cache;
alter system flush shared_pool;
```

### é‡ç°å’Œå®è·µ

è¿™æ˜¯å®è·µéƒ¨åˆ†ã€‚

#### æ­å»ºæµ‹è¯•ç¯å¢ƒ

å¦‚æœç¯å¢ƒå°±ç»ªè¯·è·³è¿‡è¿™ä¸€æ­¥ã€‚

æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ Docker æ¥å¿«é€Ÿæ­å»ºä¸€ä¸ª Oracle æ•°æ®åº“ç¯ å¢ƒã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ Docker ç¯å¢ƒï¼Œé‚£ä¹ˆé¦–å…ˆä» [è¿™é‡Œ](https://www.docker.com/get-started) ä¸‹è½½å¹¶å®‰è£… Dockerã€‚

åœ¨å‘½ä»¤è¡Œç¡®è®¤ä¸€ä¸‹ Docker ç‰ˆæœ¬ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å®‰è£…æˆåŠŸã€‚

```bash
$ docker --version
Docker version 18.09.0, build 4d60db4
```

é¦–å…ˆç™»é™† Docker Hubï¼Œä½¿ç”¨ä¸‹è½½æ—¶æ³¨å†Œçš„è´¦æˆ·ã€‚æ•²ä»¥ä¸‹å‘½ä»¤ç„¶åæ ¹æ®æç¤ºæ¥ç™»é™†å³å¯ã€‚

```bash
$ docker login
```

ç™»é™†å®Œæˆåï¼Œå¯ä»¥æ‹‰å– Oracle æ•°æ®åº“ç¯å¢ƒäº†ã€‚ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œæ‹‰å–ä¸€ä¸ªåˆ«äººå·²ç»é…ç½®å¥½çš„ Oracle 12c ç‰ˆæœ¬çš„æ•°æ®åº“ã€‚è¿™ä¸ªç‰ˆæœ¬ä¸æ˜¯ä¼ä¸šç‰ˆï¼Œä¸èƒ½åšè¡¨åˆ†åŒºï¼Œä¸è¿‡è¿™æ¬¡æˆ‘ä»¬ä¸å°è¯•è¡¨åˆ†åŒºå†…å®¹ï¼Œæ‰€ä»¥æ ‡å‡†ç‰ˆè¶³å¤Ÿäº†ã€‚

```bash
$ docker pull sath89/oracle-12c
```

æ–‡ä»¶æœ‰ç‚¹å¤§ï¼Œç­‰å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨ Oracle æ•°æ®åº“ã€‚

```bash
$ docker run -d -e WEB_CONSOLE=false -p 1521:1521 sath89/oracle-12c
```

ç¨ç­‰ç‰‡åˆ»ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºä¸€é•¿ä¸²çš„ IDï¼ŒOracle æ•°æ®åº“å·²ç»å¯åŠ¨æˆåŠŸäº†ï¼Œå¹¶ä¸”æ˜ å°„åˆ°æœ¬åœ° `1521` ç«¯å£ä¸Šäº†ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ä»»ä½•ä½ å–œæ¬¢çš„å·¥å…·è¿æ¥æ•°æ®åº“è¿›è¡Œåé¢çš„æ“ä½œäº†ã€‚è¿æ¥æ•°æ®åº“æ—¶ä½¿ç”¨ä¸‹é¢çš„å‚æ•°ã€‚

```yaml
hostname: localhost
port: 1521
sid: xe
service name: xe
username: system
password: oracle
```

ä¹Ÿå¯ä»¥ç›´æ¥è¿›å…¥è™šæ‹Ÿæœºç¯å¢ƒä¸­ä½¿ç”¨ SQL\*Plusã€‚

```bash
# é¦–å…ˆæ‹¿åˆ° Container çš„ ID
$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                              NAMES
2a00bcc34a0f        sath89/oracle-12c   "/entrypoint.sh "   8 minutes ago       Up 8 minutes        0.0.0.0:1521->1521/tcp, 8080/tcp   recursing_saha
# ç”¨æ‹¿åˆ°çš„ ID è¿›å…¥æ§åˆ¶å°
$ docker exec -it 2a00bcc34a0f /bin/bash
# å¯ä»¥çœ‹åˆ°å‰ç¼€çš„å˜æ¢ï¼Œç°åœ¨å·²ç»å¤„äºè™šæ‹Ÿæœºä¸­çš„æ§åˆ¶å°
# ç„¶åï¼Œåˆ‡æ¢åˆ° oracle ç”¨æˆ·
root@2a00bcc34a0f:/\# su oracle
# è¿›å…¥ Oracle å®‰è£…ç›®å½•
oracle@2a00bcc34a0f:/$ cd $ORACLE_HOME
# å¯åŠ¨ sqlplus
oracle@2a00bcc34a0f:/u01/app/oracle/product/12.1.0/xe$ bin/sqlplus / as sysdba

SQL*Plus: Release 12.1.0.2.0 Production on Tue Jan 8 09:51:44 2019

Copyright (c) 1982, 2014, Oracle.  All rights reserved.


Connected to:
Oracle Database 12c Standard Edition Release 12.1.0.2.0 - 64bit Production

SQL> select 1 from dual;

   1
----------
   1

SQL>
```

è¦å…³é—­ Oracle æ•°æ®åº“ï¼Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ã€‚å¦‚æœä¸çŸ¥é“ Container IDï¼Œå¯ä»¥ä½¿ç”¨ `docker ps` å‘½ä»¤æŸ¥è¯¢ã€‚

```bash
$ docker container stop [container id]
```

å‚è€ƒæ–‡æ¡£ï¼š

- [Docker Documentation](https://docs.docker.com/)
- [Docker Hub - sath89/oracle-12c](https://hub.docker.com/r/sath89/oracle-12c)

#### å‡†å¤‡æµ‹è¯•æ•°æ®

æˆ‘ä»¬ç›´æ¥æŠ½å– `dba_objects` çš„æ•°æ®ä½œä¸ºæµ‹è¯•æ•°æ®ã€‚

```sql
SQL> create table test_table as select * from dba_objects;

Table created.
```

æŸ¥çœ‹ä¸€ä¸‹æ•°æ®é‡ã€‚

```sql
SQL> select count(1) from test_table;

  COUNT(1)
----------
     90883
```

ç°åœ¨æˆ‘ä»¬çš„æµ‹è¯•æ•°æ®å‡†å¤‡å¥½äº†ï¼Œè¿™å¼ è¡¨ç›®å‰æ²¡æœ‰ä»»ä½•ç´¢å¼•ï¼Œä¸»é”®ä¹Ÿæ²¡æœ‰ã€‚

å‚è€ƒæ–‡æ¡£ï¼š

- [Database Reference - 2.179 ALL_OBJECTS](https://docs.oracle.com/database/121/REFRN/GUID-AA6DEF8B-F04F-482A-8440-DBCB18F6C976.htm#REFRN20146)

#### æ‰“å¼€ `autotrace` å’Œ `timing` æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’å’Œæ—¶é—´ã€‚

æ‰§è¡Œè®¡åˆ’å’Œæ—¶é—´æœ‰åŠ©äºåˆ†æ SQL æ€§èƒ½ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ `autotrace` å’Œ `timing` çœ‹çœ‹æ•ˆæœã€‚

```sql
SQL> set autotrace on;
SQL> set timing on;
SQL> select count(1) from test_table;

  COUNT(1)
----------
     90883

Elapsed: 00:00:00.06

Execution Plan
----------------------------------------------------------
Plan hash value: 711311523

-------------------------------------------------------------------------
| Id  | Operation          | Name       | Rows  | Cost (%CPU)| Time  |
-------------------------------------------------------------------------
|   0 | SELECT STATEMENT   |            |     1 |   416   (1)| 00:00:01 |
|   1 |  SORT AGGREGATE    |            |     1 |            |          |
|   2 |   TABLE ACCESS FULL| TEST_TABLE |   100K|   416   (1)| 00:00:01 |
-------------------------------------------------------------------------

Note
-----
   - dynamic statistics used: dynamic sampling (level=2)


Statistics
----------------------------------------------------------
    0  recursive calls
    0  db block gets
 1528  consistent gets
 1525  physical reads
    0  redo size
  544  bytes sent via SQL*Net to client
  551  bytes received via SQL*Net from client
    2  SQL*Net roundtrips to/from client
    0  sorts (memory)
    0  sorts (disk)
    1  rows processed
```

æ‰§è¡Œè®¡åˆ’çš„è§£è¯»å¯ä»¥å‚è€ƒä¸‹é¢çš„èµ„æ–™ï¼Œä½†æ˜¯å®˜æ–¹èµ„æ–™å¾ˆå¤šåœ°æ–¹éƒ½ä¸åœ¨æˆ‘ä»¬çš„å…³æ³¨ç‚¹ä¸Šï¼Œä¸è¿‡å¥½åœ¨ä»”ç»†é˜…è¯»æ‰§è¡Œè®¡åˆ’ä¹Ÿèƒ½æ‚Ÿå‡ºå¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œè‡³å°‘èµ°æ²¡èµ°ç´¢å¼•æ˜¯çœ‹ä¸€çœ¼å°±çŸ¥é“çš„ã€‚

å‚è€ƒæ–‡æ¡£ï¼š

- [Database SQL Tuning Guide - 7 Reading Execution Plans](https://docs.oracle.com/database/121/TGSQL/tgsql_interp.htm#TGSQL94618)

#### é‡ç°ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹

// TODO

```sql
create table test_dba as select rownum as id, d.*, t.* from dba_objects d, (select level as type_code from dual connect by level <= 100) t;

select
  count(1)
from
  test_dba t
where
  t.timestamp >= '2015-07-06:11:00:00'
  and t.timestamp <= '2015-07-06:12:00:00'
  and t.object_type = upper('table')
  and t.status = upper('valid');


create table characters as select
  -- è§’è‰² ID
  lpad(level, 8, '0') as character_id,
  -- ç©å®¶ IDï¼Œå¯é‡å¤
  floor(dbms_random.value(1, 500000)) as gamer_id,
  -- è§’è‰²æ€§åˆ«ï¼Œ0: Femaleï¼Œ1: Male
  floor(dbms_random.value(0, 2)) as character_gender,
  -- è§’è‰²ç­‰çº§
  floor(dbms_random.value(1, 100)) as character_level,
  -- è§’è‰²æŒæœ‰çš„é‡‘å¸
  floor(dbms_random.value(1, 100)) as character_coin,
  -- åˆ›å»ºæ—¶é—´
  current_timestamp as create_date,
  -- è§’è‰²åç§°
  'NAME_' || level as character_name,
  -- å…¶ä»–çš„å­—æ®µ
  'INFO1_' || current_timestamp as character_info1,
  'INFO2_' || current_timestamp as character_info2,
  'INFO3_' || current_timestamp as character_info3
from dual connect by level <= 500000;

alter table characters 
  alter column character_id varchar2(8) not null;
alter table characters 
  add constraint characters_pk primary key (character_id);

SELECT ABS(MOD(DBMS_RANDOM.RANDOM,100000000)) FROM DUAL;

select count(1) from (
select gamer_id from characters group by gamer_id having count(gamer_id) > 1);

select character_id, gamer_id, character_gender, character_level from characters where rownum <= 10;

select max(count(gamer_id)) from characters group by gamer_id having count(1) > 1;

SELECT segment_name AS TABLENAME,
       BYTES B,
       BYTES / 1024 KB,
       BYTES / 1024 / 1024 MB
  FROM user_segments
where segment_name = upper('characters');

```


**âš ï¸ Tips**

æ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œä¸è¿‡ä¸ºäº†æ–¹ä¾¿å†ç°æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶ä¸€ä¸‹ Docker å¼•æ“ä½¿ç”¨çš„ CPU èµ„æºï¼Œå‚è€ƒä¸‹å›¾ã€‚

![Docker Configuration](/img/DockerConfiguration.png)
