---
title: 为什么使用 yarn？
subtitle: 使用 yarn 而不是 npm 的理由。
date: 2019-02-27 18:31:00 +8
lastUpdateTime: 2019-03-17 16:43:09 +8
tags:
  - Node.js
  - JavaScript
---

最近有做一个使用流行前端框架的页面 Demo 向客户提案，我做完页面之后移交给同事时遇到了一个问题，我使用的是 yarn，但是同事只用过 npm。

好在最后 `npm install` 没有产生任何依赖问题，不过却让我产生了一个疑问，并且这个问题当时的我无法很清楚地回答出来——为什么使用 yarn？

npm 作为 Node.js 的官方包管理工具，是我们最初接触 Node.js 的首选。曾经它存在过很多不可思议的问题，据说严重程度超过了那些使用 Node.js 开发业务的大公司的承受极限，所以他们主导开源了新的工具 yarn，来修正 npm 出现的问题。

不过我并没有经历过这个时期，我使用 yarn 只是因为一次机缘巧合，在了解到相关的背景之后，决定试一试 yarn，之后便一直使用了下来，没有其他的理由。

这次遇到的问题让我产生了兴趣，所以让我们来探究一下 npm 和 yarn 的历史与现状吧。

> 由于时间有限，无法依次安装历史版本重现历史问题，这篇文章仅仅做资料总结。

### 先来聊聊 npm

npm 伴随 Node.js 的安装而被默认安装，就如其名，`Node Package Manager`，官方的包管理工具。它可以帮你管理依赖关系，比如安装、卸载和更新 JavaScript 的依赖包，同时它还有另外一个重要的功能，就是发布你自己的包，和其他人分享你的代码。当然，现在我们的关注点是 npm 的包管理功能，这也是 yarn 与其竞争的地方。

在上古时期，大概是 5.0 版本以前，npm 存在两个主要的缺陷。

其一是依赖版本的问题，npm 默认情况下不使用 `.lockfile`，所以无法精准记录依赖版本，导致每次重新安装依赖的时候，安装的都是当前时间的最新版本的依赖，这存在一个重大的风险，你的代码可能和当前最新版本的依赖不兼容，导致你的程序崩溃。

虽然当时 npm 有一个什么什么命令可以生成一个 package-lock.json 文件记录依赖的精准版本信息，但体验太差，且目前已经过时了，名称也懒得找了。很难理解为什么 npm 会出现这么严重的缺陷。

另一个问题是 node_modules 目录。执行同样的 `npm install` 命令，你的 node_modules 目录结构可能和你同事的完全不一样。这会产生很多”it works for me“的问题。

### yarn 的诞生

yarn 诞生最初就是为了解决这两个主要的问题。

yarn 默认生成一个 yarn.lock 文件，记录精确的版本信息，每次的重新安装依赖都会安装对应仓库对应的版本，从此不存在版本问题。

yarn 安装具有确定性，你和你的同事执行相同的 `yarn` 命令，将得到相同的 node_modules 目录，从此不再有”it works for me“问题。

同时 yarn 还对 npm 曾经的痛点做了很多改善。

安装速度。npm 安装依赖时执行顺序安装，所有下载任务排成队列，一个一个来，速度慢，且单个安装任务失败会造成整体安装任务的失败。yarn 执行并行安装，多线程执行安装任务，速度快，且单个安装任务失败不会造成整体失败，而是自动重试。

安全问题。npm 允许依赖安装完成后自动运行代码，虽然提供了很多便利，但是也造成了安全隐患。yarn 仅仅安装 yarn.lock 或 package.json 中的依赖，更为安全。

另一方面 yarn 提供离线安装模式，对已经下载过的依赖版本不再重新下载，将直接复用，进一步提高安装速度。

yarn 还提供了更友好的命令，不像 npm， 除了 `npm start` 够简短，其他的脚本都必须以 `npm run` 开头。在 yarn 中，`npm install` 是 `yarn`，`npm run script` 是 `yarn script`。

yarn 在安装依赖时自动添加到 package.json，npm 中你需要 `--save` 参数才能做到。

还有，yarn 使用了更多的 emoji。

### 关于 npm 5.0

2017 年发布的 npm 5.0 版本解决了它的两个主要的缺陷，并且还对其他一些问题做了一些好的改善。

npm 安装依赖将默认生成 package-lock.json 文件，记录精确的版本信息，每次重新安装依赖将得到相同的版本。

npm 提升了安装速度，但依然打不过 yarn。

npm 安装依赖自动添加到 package.json。

npm 也提供了离线模式，对于曾经安装过的依赖将复用缓存。

这样对比一下，似乎 yarn 想要解决的问题 npm 都已经解决了。yarn 还剩下什么优势呢？

大概只有 cli 接口，和更多 emoji 了吧？

### 总结

npm 6.0 着重改进了安全性，目前最新版本的 npm 和 yarn 在功能性上没有太大的差距，所以初学者没有必要特意去了解和接触 yarn 了。

个人主观认为，yarn 目前比 npm 好的地方可能只有更友好的 cli 接口，已经更清晰的安装 log，和更多的 emoji 了吧。

不过 yarn 仍然是 npm 的另一个可靠的选择，当你用腻了 npm 之后，可以换一个口味试试 yarn。
